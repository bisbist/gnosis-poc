import * as dotenv from "dotenv";
import { ethers, Wallet } from "ethers";
import Safe, { SafeFactory } from "@safe-global/protocol-kit";
import { EthersAdapter } from "@safe-global/protocol-kit";
import SafeApiKit from "@safe-global/api-kit";
import {CreateCallAbi} from "./ABI.js";

dotenv.config();

const SAFE_ADDRESS = process.env.SAFE_ADDRESS;
const provider = new ethers.providers.JsonRpcProvider(
    "https://eth-goerli.g.alchemy.com/v2/fLCeKO4GA9Gc3js8MUt9Djy7WHCFxATq"
);
const deployerSigner = new ethers.Wallet(process.env.secret_key1, provider);
const bytecode = "0x60a06040523073ffffffffffffffffffffffffffffffffffffffff1660809073ffffffffffffffffffffffffffffffffffffffff1681525034801561004357600080fd5b5060805161163b61007b6000396000818161017d0152818161020c0152818161030c0152818161039b015261044b015261163b6000f3fe6080604052600436106100705760003560e01c806352d1902d1161004e57806352d1902d146100e55780636036251414610110578063d5f3948814610127578063fe4b84df1461015257610070565b80633659cfe6146100755780634e70b1dc1461009e5780634f1ef286146100c9575b600080fd5b34801561008157600080fd5b5061009c60048036038101906100979190610c3d565b61017b565b005b3480156100aa57600080fd5b506100b3610304565b6040516100c09190610c83565b60405180910390f35b6100e360048036038101906100de9190610de4565b61030a565b005b3480156100f157600080fd5b506100fa610447565b6040516101079190610e59565b60405180910390f35b34801561011c57600080fd5b50610125610500565b005b34801561013357600080fd5b5061013c61051c565b6040516101499190610e83565b60405180910390f35b34801561015e57600080fd5b5061017960048036038101906101749190610eca565b610542565b005b7f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff163073ffffffffffffffffffffffffffffffffffffffff16141561020a576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161020190610f7a565b60405180910390fd5b7f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff166102496106ce565b73ffffffffffffffffffffffffffffffffffffffff161461029f576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016102969061100c565b60405180910390fd5b6102a881610725565b61030181600067ffffffffffffffff8111156102c7576102c6610cb9565b5b6040519080825280601f01601f1916602001820160405280156102f95781602001600182028036833780820191505090505b506000610782565b50565b60015481565b7f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff163073ffffffffffffffffffffffffffffffffffffffff161415610399576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161039090610f7a565b60405180910390fd5b7f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff166103d86106ce565b73ffffffffffffffffffffffffffffffffffffffff161461042e576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016104259061100c565b60405180910390fd5b61043782610725565b61044382826001610782565b5050565b60007f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff163073ffffffffffffffffffffffffffffffffffffffff16146104d7576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016104ce9061109e565b60405180910390fd5b7f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc60001b905090565b60026001600082825461051391906110ed565b92505081905550565b600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60008060019054906101000a900460ff161590508080156105735750600160008054906101000a900460ff1660ff16105b806105a05750610582306108ff565b15801561059f5750600160008054906101000a900460ff1660ff16145b5b6105df576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016105d6906111b9565b60405180910390fd5b60016000806101000a81548160ff021916908360ff160217905550801561061c576001600060016101000a81548160ff0219169083151502179055505b6000821161062957600080fd5b8160018190555033600260006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555080156106ca5760008060016101000a81548160ff0219169083151502179055507f7f26b83ff96e1f2b6a682f133852f6798a09c465da95921460cefb384740249860016040516106c1919061122b565b60405180910390a15b5050565b60006106fc7f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc60001b610922565b60000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905090565b600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161461077f57600080fd5b50565b6107ae7f4910fdfa16fed3260ed0e7147f7cc6da11a60208b5b9406d12a635614ffd914360001b61092c565b60000160009054906101000a900460ff16156107d2576107cd83610936565b6108fa565b8273ffffffffffffffffffffffffffffffffffffffff166352d1902d6040518163ffffffff1660e01b815260040160206040518083038186803b15801561081857600080fd5b505afa92505050801561084957506040513d601f19601f820116820180604052508101906108469190611272565b60015b610888576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161087f90611311565b60405180910390fd5b7f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc60001b81146108ed576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016108e4906113a3565b60405180910390fd5b506108f98383836109ef565b5b505050565b6000808273ffffffffffffffffffffffffffffffffffffffff163b119050919050565b6000819050919050565b6000819050919050565b61093f816108ff565b61097e576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161097590611435565b60405180910390fd5b806109ab7f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc60001b610922565b60000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050565b6109f883610a1b565b600082511180610a055750805b15610a1657610a148383610a6a565b505b505050565b610a2481610936565b8073ffffffffffffffffffffffffffffffffffffffff167fbc7cd75a20ee27fd9adebab32041f755214dbc6bffa90cc0225b39da2e5c2d3b60405160405180910390a250565b6060610a8f83836040518060600160405280602781526020016115df60279139610a97565b905092915050565b6060610aa2846108ff565b610ae1576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610ad8906114c7565b60405180910390fd5b6000808573ffffffffffffffffffffffffffffffffffffffff1685604051610b099190611561565b600060405180830381855af49150503d8060008114610b44576040519150601f19603f3d011682016040523d82523d6000602084013e610b49565b606091505b5091509150610b59828286610b64565b925050509392505050565b60608315610b7457829050610bc4565b600083511115610b875782518084602001fd5b816040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610bbb91906115bc565b60405180910390fd5b9392505050565b6000604051905090565b600080fd5b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000610c0a82610bdf565b9050919050565b610c1a81610bff565b8114610c2557600080fd5b50565b600081359050610c3781610c11565b92915050565b600060208284031215610c5357610c52610bd5565b5b6000610c6184828501610c28565b91505092915050565b6000819050919050565b610c7d81610c6a565b82525050565b6000602082019050610c986000830184610c74565b92915050565b600080fd5b600080fd5b6000601f19601f8301169050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b610cf182610ca8565b810181811067ffffffffffffffff82111715610d1057610d0f610cb9565b5b80604052505050565b6000610d23610bcb565b9050610d2f8282610ce8565b919050565b600067ffffffffffffffff821115610d4f57610d4e610cb9565b5b610d5882610ca8565b9050602081019050919050565b82818337600083830152505050565b6000610d87610d8284610d34565b610d19565b905082815260208101848484011115610da357610da2610ca3565b5b610dae848285610d65565b509392505050565b600082601f830112610dcb57610dca610c9e565b5b8135610ddb848260208601610d74565b91505092915050565b60008060408385031215610dfb57610dfa610bd5565b5b6000610e0985828601610c28565b925050602083013567ffffffffffffffff811115610e2a57610e29610bda565b5b610e3685828601610db6565b9150509250929050565b6000819050919050565b610e5381610e40565b82525050565b6000602082019050610e6e6000830184610e4a565b92915050565b610e7d81610bff565b82525050565b6000602082019050610e986000830184610e74565b92915050565b610ea781610c6a565b8114610eb257600080fd5b50565b600081359050610ec481610e9e565b92915050565b600060208284031215610ee057610edf610bd5565b5b6000610eee84828501610eb5565b91505092915050565b600082825260208201905092915050565b7f46756e6374696f6e206d7573742062652063616c6c6564207468726f7567682060008201527f64656c656761746563616c6c0000000000000000000000000000000000000000602082015250565b6000610f64602c83610ef7565b9150610f6f82610f08565b604082019050919050565b60006020820190508181036000830152610f9381610f57565b9050919050565b7f46756e6374696f6e206d7573742062652063616c6c6564207468726f7567682060008201527f6163746976652070726f78790000000000000000000000000000000000000000602082015250565b6000610ff6602c83610ef7565b915061100182610f9a565b604082019050919050565b6000602082019050818103600083015261102581610fe9565b9050919050565b7f555550535570677261646561626c653a206d757374206e6f742062652063616c60008201527f6c6564207468726f7567682064656c656761746563616c6c0000000000000000602082015250565b6000611088603883610ef7565b91506110938261102c565b604082019050919050565b600060208201905081810360008301526110b78161107b565b9050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b60006110f882610c6a565b915061110383610c6a565b9250817fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff048311821515161561113c5761113b6110be565b5b828202905092915050565b7f496e697469616c697a61626c653a20636f6e747261637420697320616c72656160008201527f647920696e697469616c697a6564000000000000000000000000000000000000602082015250565b60006111a3602e83610ef7565b91506111ae82611147565b604082019050919050565b600060208201905081810360008301526111d281611196565b9050919050565b6000819050919050565b600060ff82169050919050565b6000819050919050565b600061121561121061120b846111d9565b6111f0565b6111e3565b9050919050565b611225816111fa565b82525050565b6000602082019050611240600083018461121c565b92915050565b61124f81610e40565b811461125a57600080fd5b50565b60008151905061126c81611246565b92915050565b60006020828403121561128857611287610bd5565b5b60006112968482850161125d565b91505092915050565b7f45524331393637557067726164653a206e657720696d706c656d656e7461746960008201527f6f6e206973206e6f742055555053000000000000000000000000000000000000602082015250565b60006112fb602e83610ef7565b91506113068261129f565b604082019050919050565b6000602082019050818103600083015261132a816112ee565b9050919050565b7f45524331393637557067726164653a20756e737570706f727465642070726f7860008201527f6961626c65555549440000000000000000000000000000000000000000000000602082015250565b600061138d602983610ef7565b915061139882611331565b604082019050919050565b600060208201905081810360008301526113bc81611380565b9050919050565b7f455243313936373a206e657720696d706c656d656e746174696f6e206973206e60008201527f6f74206120636f6e747261637400000000000000000000000000000000000000602082015250565b600061141f602d83610ef7565b915061142a826113c3565b604082019050919050565b6000602082019050818103600083015261144e81611412565b9050919050565b7f416464726573733a2064656c65676174652063616c6c20746f206e6f6e2d636f60008201527f6e74726163740000000000000000000000000000000000000000000000000000602082015250565b60006114b1602683610ef7565b91506114bc82611455565b604082019050919050565b600060208201905081810360008301526114e0816114a4565b9050919050565b600081519050919050565b600081905092915050565b60005b8381101561151b578082015181840152602081019050611500565b8381111561152a576000848401525b50505050565b600061153b826114e7565b61154581856114f2565b93506115558185602086016114fd565b80840191505092915050565b600061156d8284611530565b915081905092915050565b600081519050919050565b600061158e82611578565b6115988185610ef7565b93506115a88185602086016114fd565b6115b181610ca8565b840191505092915050565b600060208201905081810360008301526115d68184611583565b90509291505056fe416464726573733a206c6f772d6c6576656c2064656c65676174652063616c6c206661696c6564a264697066735822122053a3adf5b27491c44ba17b243a1daefa234863fed8e8981a8fc6ecce14c8f35d64736f6c63430008090033";

// Encode deployment
const deployerInterface = new ethers.utils.Interface(CreateCallAbi);
const deployCallData = deployerInterface.encodeFunctionData("performCreate", [
    0,
    bytecode,
]);

const ethAdapter = new EthersAdapter({
    ethers,
    signerOrProvider: deployerSigner,
});
const safeService = new SafeApiKit.default({
    txServiceUrl: "https://safe-transaction-goerli.safe.global",
    ethAdapter,
});

const txData = {
    to: "0x8BE892bdDaDb80182108Cc58e74Fece9fc159841",
    value: "0",
    data: deployCallData,
};
const safeSdk = await Safe.default.create({
    ethAdapter: ethAdapter,
    safeAddress: SAFE_ADDRESS,
});
const safeTx = await safeSdk.createTransaction({
    safeTransactionData: txData,
});
const safeTxHash = await safeSdk.getTransactionHash(safeTx);

const signature = await safeSdk.signTypedData(safeTx);
console.log("txn hash", safeTxHash);

const transactionConfig = {
    safeAddress: SAFE_ADDRESS,
    safeTransactionData: safeTx.data,
    safeTxHash: safeTxHash,
    senderAddress: process.env.SENDER_ADDRESS,
    senderSignature: signature.data,
};

await safeService.proposeTransaction(transactionConfig);